# VPCs

- Think of a VPC as a logical datacenter in AWS
- Consists of IGWs (Or Virtual Private Gateways), Route Tables, Network Access Control lists. Subnets, and Security Groups
- 1 Subnet = 1 Availability Zone
- Security Groups are Stateful, ACL lists are Stateless
- NO TRANSITIVE PEERING
- Build of VPC

    ![VPC](https://k2y3h8q6.stackpathcdn.com/wp-content/uploads/2018/12/AWSTrainingAmazonVPC5.jpg)
- A diagram of default VPC

    ![AWSTrainingAmazonVPC1](https://k2y3h8q6.stackpathcdn.com/wp-content/uploads/2018/12/AWSTrainingAmazonVPC1.jpg)
- A diagram of non-default VPC

    ![AWSTrainingAmazonVPC2](https://k2y3h8q6.stackpathcdn.com/wp-content/uploads/2018/12/AWSTrainingAmazonVPC2.jpg)

## NAT instances vs NAT gateways

### __NAT instances__

- When creating a NAT instance, Disable Source / Destination Check on the Instance
- Must be in a public subnet
- There must be a route out of the private subnet to the NAT instance, in order for this to work
- The amount of traffic that NAT instance can support depends on the instance size. If you are bottlenecking, increase the instance size
- You can create high availability using Autoscaling Groups, multiple subnets in different AZs, and a script to automate failover

### __NAT gateways__

- Redundant inside the Availability Zone
- Preferred by the enterprise
- Starts at 5Gbps and scales currently to 45Gbps
- No need to patch
- Not associated with security groups
- Automatically assigned a public ip address
- Remember to update your route tables
- No need to disable Source/Destination Checks

- If you have resources in multiple Availability Zones and they share one NAT gateway, in the event that the NAT gateway's Availability Zone is down, - resources in the other Availability Zones lose internet access. To create an Availability Zone-independent architecture, create a NAT gateway in each AZ - and configure your routing to ensure that resources use the NAT gateway in the same AZ

## Network ACL's

- Your VPC automatically comes with a default network ACL, and by default it allows all outboud and inbound traffic
- You can create custom network ACLs. By default, each custom network ACL denies all inboud and outboud traffic until you add rules.
- Each subnet in your VPC must be associated with a network ACL. If you don't explicitly associate a subnet with a network ACL, the subnet is automatically - assiciated with the default network ACL.
- Block IP Addresses using network ACLs not Security Groups

- You can associate a network ACL with multiple subnets; however, a  subnet can be associated with only one network ACL at a time. When you associate a - network ACL with a subnet, the previous association is removed
- Network ACLs contain a numbered list of rules that is evaluated in order, starting with the lowest numbered rule
- Network ACLs have separate inbound and outbound rules, and each rule can either allow or deny traffic
- Network ACLs are stateless; responses to allowed inbound traffic are subject to the rules for outbound traffic(and vice versa).

## ELB's and VPCs

- You need a minimum of two public subets to deploy and internet facing loadbalancer

## VPC flow logs

- You cannot enable flow logs for VPCs that are peered with your VPC unless the peer VPC is in your account
- You cannot tag a flow log
- After you've created a flow log, you cannot change its configuration; for example, you canâ€™t associate a different IAM role with the flow log

### Not all IP traffic is monitored

- Traffic generated by instances when they contact the amazon DNS server. If you use your own DNS server, then all traffic to that DNS server is logged
- Traffic generated by a Windows instance for Amazon Windows license activation
- Traffic to and from 169.254.169.254 for instance metadata
- DHCP traffic
- Traffic to the reserved IP address for the default VPC router

## Bastions vs NAT Gateways/Instances

- A NAT Gateway or NAT Instance is used to provide internet traffic to EC2 instances in a private subnets
- A Bastion is used to securely Administer EC2 instances (Using SSH or RDP). Bastions are called Jump Boxes in Australia
- You cannot use a NAT gateway as a Bastion host

## Direct Connect

- Direct  connect directly connects your data center to AWS
- Useful for high throughput workloads (ie losts of network traffic)
- Or if you need a stable and reliable secure connection

## VPC Endpoint

- Enables you to privately connect your VPC to supported AWS services and VPC endpoint services powered by PrivateLink without requiring an internet gateway,-  NAT device, VPN connection, or AWS direct connect connection.
- Instances in your VPC do not require public IP addressed to communicate with resources in the service.
- Traffic between your VPC and the other service does not leave the Amazon network

- Endpoints are virtual devices. They are horizontally scaled, redundant, and highly available VPC components that allow communication between instances in - your VPC and services without imposing availability risks or bandwidth constraints on your network traffic

### VPC endpoint types

- Interface Endpoints
- Gateway Endpoints Support:
  - Amazon S3
  - DynamoDB
